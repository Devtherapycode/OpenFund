# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OpenFund is a .NET 8.0 web API built using Clean Architecture principles with three main layers:
- **OpenFund.Api**: ASP.NET Core Web API with minimal APIs (endpoints)
- **OpenFund.Core**: Domain entities, DTOs, service interfaces, and business logic
- **OpenFund.Infrastructure**: Data persistence (EF Core, PostgreSQL), authentication (JWT), and external dependencies

## Common Commands

### Build and Run
```bash
# Build entire solution
dotnet build

# Run the API (from root directory)
dotnet run --project src/OpenFund.Api/OpenFund.Api.csproj

# Run with watch (auto-reload on changes)
dotnet watch --project src/OpenFund.Api/OpenFund.Api.csproj
```

### Testing
```bash
# Run all tests
dotnet test

# Run tests with detailed output
dotnet test --verbosity normal

# Run a specific test
dotnet test --filter "FullyQualifiedName~TestMethodName"
```

### Database Migrations
```bash
# Add a new migration
dotnet ef migrations add MigrationName --project src/OpenFund.Infrastructure/OpenFund.Infrastructure.csproj --startup-project src/OpenFund.Api/OpenFund.Api.csproj

# Update database to latest migration
dotnet ef database update --project src/OpenFund.Infrastructure/OpenFund.Infrastructure.csproj --startup-project src/OpenFund.Api/OpenFund.Api.csproj

# Remove last migration (if not applied)
dotnet ef migrations remove --project src/OpenFund.Infrastructure/OpenFund.Infrastructure.csproj --startup-project src/OpenFund.Api/OpenFund.Api.csproj
```

## Architecture

### Dependency Flow
- **Api** → depends on **Core** + **Infrastructure**
- **Infrastructure** → depends on **Core**
- **Core** → no dependencies (domain layer)

### Authentication & Authorization
- Uses ASP.NET Core Identity with custom `User` entity (extends `IdentityUser<Guid>`)
- JWT Bearer token authentication configured via `JwtOptions` (Issuer, Audience, Key)
- JWT tokens generated by `JwtProvider` in Infrastructure layer
- Auth endpoints: `/auth/register`, `/auth/login`, `/me` (requires authorization)

### Dependency Injection
Services are registered via extension methods:
- `AddCoreServices()`: Registers `IAuthService`, `IPasswordHasher<User>`
- `AddInfrastructure(config)`: Registers DbContext (PostgreSQL), `IUsersRepo`, `IJwtProvider`
- `AddAuth(config)`: Registers Identity, JWT authentication, authorization, and Swagger with JWT support

### Endpoints Pattern
Endpoints are defined as extension methods that map routes to handlers (minimal API style):
- Located in `src/OpenFund.Api/Endpoints/`
- Registered in `Program.cs` via `app.MapAuthEndpoints()`
- Use dependency injection for services (e.g., `IAuthService`)

### Data Access
- EF Core with PostgreSQL via `OpenFundDbContext` (extends `IdentityDbContext<User, IdentityRole<Guid>, Guid>`)
- Repository pattern: interfaces in `Core/Abstractions`, implementations in `Infrastructure/Persistence`
- Connection string configured in `appsettings.json` under `ConnectionStrings:Default`

### Testing
- xUnit test framework with FluentAssertions, Moq, and EF Core InMemory provider
- Tests in `tests/OpenFund.UnitTests/`
- `InternalsVisibleTo` attribute grants test project access to internal members in Core and Infrastructure

## Configuration

JWT settings must be configured in `appsettings.json` or user secrets:
```json
{
  "Jwt": {
    "Issuer": "your-issuer",
    "Audience": "your-audience",
    "Key": "your-secret-key"
  },
  "ConnectionStrings": {
    "Default": "Host=localhost;Database=openfund;Username=user;Password=pass"
  }
}
```
